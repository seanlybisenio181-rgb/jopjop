<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Supercentenarian Wiki (Local • Offline • Infinite)</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --muted:#1a2230; --text:#e7eef7; --soft:#b7c3d9; --accent:#7cc4ff; --accent-2:#b98cff; --danger:#ff7c9a; --ok:#80e5a0; --warn:#ffd27c;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; background:linear-gradient(180deg,#0b0f14,#0e141c); color:var(--text)}
    a{color:var(--accent)}
    .app{max-width:1100px;margin:0 auto;padding:20px}
    .nav{position:sticky;top:0;background:rgba(9,13,18,.75);backdrop-filter: blur(8px);display:flex;gap:12px;align-items:center;padding:14px;border-bottom:1px solid #1d2937;z-index:30}
    .badge{font-size:12px;padding:4px 8px;border:1px solid #283548;border-radius:999px;background:#0f1621;color:var(--soft)}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800;letter-spacing:.2px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2))}
    .spacer{flex:1}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--muted);color:var(--text);cursor:pointer;transition:.15s box-shadow,.15s transform,.15s background}
    .btn:hover{box-shadow:0 6px 18px rgba(0,0,0,.25);transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#08121c;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid #273140}
    .btn.warn{background:linear-gradient(135deg,#ff9a7c,#ffd27c);color:#26130a}
    .searchbox{position:relative;flex:1;max-width:520px}
    .searchbox input{width:100%;padding:12px 14px 12px 40px;border-radius:12px;border:1px solid #2b3a4f;background:#0f1621;color:var(--text)}
    .searchbox svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.7}
    .suggest{position:absolute;left:0;right:0;top:calc(100% + 6px);background:#0f1621;border:1px solid #2b3a4f;border-radius:12px;box-shadow:var(--shadow);max-height:280px;overflow:auto;display:none}
    .suggest.visible{display:block}
    .suggest div{padding:10px 12px;cursor:pointer;border-bottom:1px solid #203046}
    .suggest div:last-child{border-bottom:none}
    .suggest .cat{font-size:11px;color:#8ea6c8;text-transform:uppercase;letter-spacing:.08em;padding:8px 12px;background:#0b111a;position:sticky;top:0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .card{background:linear-gradient(180deg,#101724,#0d1320);border:1px solid #1f2a3a;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .card h3{margin:0 0 6px 0}
    .meta{font-size:13px;color:var(--soft)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0f1828;border:1px solid #263247;font-size:12px;color:#9fb5d3;margin-right:6px}
    .section{margin:24px 0}
    .section h2{margin:0 0 12px 0}
    .form{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .field{grid-column:span 6}
    .field.full{grid-column:1/-1}
    .field label{display:block;font-size:12px;color:#9fb5d3;margin:4px 2px}
    .field input,.field textarea,.field select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2b3a4f;background:#0f1621;color:var(--text)}
    .list{background:#0f1621;border:1px solid #263247;border-radius:12px}
    .list-row{display:flex;gap:8px;padding:10px;border-bottom:1px solid #1e2a3b}
    .list-row:last-child{border-bottom:none}
    .small{font-size:12px;color:#8ea6c8}
    .footer{opacity:.7;font-size:12px;margin-top:18px}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:8px 10px;border-radius:10px;border:1px solid #2b3a4f;background:#0f1621;cursor:pointer}
    .tab.active{background:linear-gradient(135deg,#152233,#0f1621);border-color:#405173}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px;padding:2px 6px;border-radius:6px;background:#0d1320;border:1px solid #313e55;color:#9fb5d3}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px dashed #33445d;border-radius:999px}
    .empty{padding:20px;border:1px dashed #33445d;border-radius:12px;text-align:center;color:#9fb5d3}
    .hero{display:grid;grid-template-columns:1.6fr 1fr;gap:16px;align-items:center}
    @media (max-width: 900px){ .hero{grid-template-columns:1fr} .nav{flex-wrap:wrap} }
  </style>
</head>
<body>
  <div class="nav">
    <div class="brand"><span class="dot"></span> Supercentenarian Wiki <span class="badge">Local • Editable</span></div>
    <div class="spacer"></div>
    <div class="searchbox">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      <input id="globalSearch" placeholder="Search names or countries (e.g., ‘Venezuelan’)…" />
      <div id="suggest" class="suggest"></div>
    </div>
    <button class="btn ghost" onclick="Router.go('#/home')">Home</button>
    <button class="btn ghost" onclick="Router.go('#/new')">Add</button>
    <button class="btn ghost" onclick="Router.go('#/browse')">Browse</button>
    <button class="btn primary" onclick="Backup.exportJSON()">Export</button>
    <label class="btn" for="importFile">Import</label>
    <input id="importFile" type="file" accept="application/json" style="display:none" />
  </div>

  <div class="app" id="app"></div>

  <script>
  // ===== UTILITIES ==========================================================
  const $ = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];
  const fmt = n => new Intl.NumberFormat().format(n);
  const todayISO = () => new Date().toISOString().slice(0,10);
  const slugify = s => s.toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
  const yearsBetween = (a,b) => Math.max(0, Math.floor((b-a)/ (365.2425*24*3600*1000)));
  const parseDate = d => d ? new Date(d) : null;
  const safe = v => v==null?'' : String(v);

  // Country list (ISO-like, 249 entries inc. territories) — truncated display uses search, so long list is OK
  const COUNTRIES = [
    "Afghanistan","Åland Islands","Albania","Algeria","American Samoa","Andorra","Angola","Anguilla","Antarctica","Antigua and Barbuda","Argentina","Armenia","Aruba","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bermuda","Bhutan","Bolivia","Bonaire, Sint Eustatius and Saba","Bosnia and Herzegovina","Botswana","Bouvet Island","Brazil","British Indian Ocean Territory","Brunei Darussalam","Bulgaria","Burkina Faso","Burundi","Cabo Verde","Cambodia","Cameroon","Canada","Cayman Islands","Central African Republic","Chad","Chile","China","Christmas Island","Cocos (Keeling) Islands","Colombia","Comoros","Congo","Congo, Democratic Republic of the","Cook Islands","Costa Rica","Côte d’Ivoire","Croatia","Cuba","Curaçao","Cyprus","Czechia","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini","Ethiopia","Falkland Islands (Malvinas)","Faroe Islands","Fiji","Finland","France","French Guiana","French Polynesia","French Southern Territories","Gabon","Gambia","Georgia","Germany","Ghana","Gibraltar","Greece","Greenland","Grenada","Guadeloupe","Guam","Guatemala","Guernsey","Guinea","Guinea-Bissau","Guyana","Haiti","Heard Island and McDonald Islands","Holy See","Honduras","Hong Kong","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland","Isle of Man","Israel","Italy","Jamaica","Japan","Jersey","Jordan","Kazakhstan","Kenya","Kiribati","Korea (North)","Korea (South)","Kuwait","Kyrgyzstan","Lao People’s Democratic Republic","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Macao","Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands","Martinique","Mauritania","Mauritius","Mayotte","Mexico","Micronesia","Moldova","Monaco","Mongolia","Montenegro","Montserrat","Morocco","Mozambique","Myanmar","Namibia","Nauru","Nepal","Netherlands","New Caledonia","New Zealand","Nicaragua","Niger","Nigeria","Niue","Norfolk Island","North Macedonia","Northern Mariana Islands","Norway","Oman","Pakistan","Palau","Palestine, State of","Panama","Papua New Guinea","Paraguay","Peru","Philippines","Pitcairn","Poland","Portugal","Puerto Rico","Qatar","Réunion","Romania","Russian Federation","Rwanda","Saint Barthélemy","Saint Helena, Ascension and Tristan da Cunha","Saint Kitts and Nevis","Saint Lucia","Saint Martin","Saint Pierre and Miquelon","Saint Vincent and the Grenadines","Samoa","San Marino","Sao Tome and Principe","Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore","Sint Maarten","Slovakia","Slovenia","Solomon Islands","Somalia","South Africa","South Georgia and the South Sandwich Islands","South Sudan","Spain","Sri Lanka","Sudan","Suriname","Svalbard and Jan Mayen","Sweden","Switzerland","Syrian Arab Republic","Taiwan","Tajikistan","Tanzania","Thailand","Timor-Leste","Togo","Tokelau","Tonga","Trinidad and Tobago","Tunisia","Turkey","Turkmenistan","Turks and Caicos Islands","Tuvalu","Uganda","Ukraine","United Arab Emirates","United Kingdom","United States of America","United States Minor Outlying Islands","Uruguay","Uzbekistan","Vanuatu","Venezuela","Viet Nam","Virgin Islands (British)","Virgin Islands (U.S.)","Wallis and Futuna","Western Sahara","Yemen","Zambia","Zimbabwe"
  ];

  // ===== DATA LAYER (LocalStorage) =========================================
  const DB_KEY = 'sc_wiki_v1';
  const DB = {
    load(){
      try{ return JSON.parse(localStorage.getItem(DB_KEY)) || {people:[], history:[], lastId:0}; }
      catch(e){ return {people:[], history:[], lastId:0}; }
    },
    save(state){ localStorage.setItem(DB_KEY, JSON.stringify(state)); },
    clear(){ localStorage.removeItem(DB_KEY); },
  };
  let state = DB.load();

  // ===== ROUTER =============================================================
  const Router = {
    go(hash){ location.hash = hash; },
    on(){
      const route = location.hash.replace('#','') || '/home';
      if(route.startsWith('/p/')) return Views.person(route.split('/p/')[1]);
      if(route.startsWith('/edit/')) return Views.edit(route.split('/edit/')[1]);
      if(route.startsWith('/new')) return Views.edit('new');
      if(route.startsWith('/browse')) return Views.browse();
      if(route.startsWith('/countries')) return Views.countries();
      return Views.home();
    }
  };
  window.addEventListener('hashchange', Router.on);
  window.addEventListener('load', Router.on);

  // ===== BACKUP =============================================================
  const Backup = {
    exportJSON(){
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download='supercentenarian_wiki_backup_'+Date.now()+'.json';
      a.click(); URL.revokeObjectURL(url);
    },
    async importJSON(file){
      const text = await file.text();
      try{
        const data = JSON.parse(text);
        if(!data.people) throw new Error('Invalid file');
        state = data; DB.save(state); Router.on();
        toast('Import successful. '+fmt(state.people.length)+' profiles loaded.', 'ok');
      }catch(e){ toast('Import failed: '+e.message, 'danger'); }
    }
  };
  $('#importFile').addEventListener('change', e=>{
    const f=e.target.files[0]; if(f) Backup.importJSON(f);
  });

  // ===== TOASTS =============================================================
  function toast(msg, kind='info'){
    let t=document.createElement('div'); t.textContent=msg; t.style.cssText=`position:fixed;right:16px;bottom:16px;background:${kind==='danger'?'#3a1020':kind==='ok'?'#0f2a1c':'#101724'};color:var(--text);border:1px solid #2b3a4f;border-left:4px solid ${kind==='danger'?'#ff7c9a':kind==='ok'?'#80e5a0':'#7cc4ff'};padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:50`;
    document.body.appendChild(t); setTimeout(()=>t.remove(), 2800);
  }

  // ===== SEARCH / SUGGEST ===================================================
  const Search = {
    index(){
      const names = state.people.map(p=>({type:'person', key: p.name, slug:p.slug}));
      const countries = [...new Set(state.people.map(p=>p.birthCountry))].map(c=>({type:'country', key:c}));
      const allCountries = COUNTRIES.map(c=>({type:'country', key:c}));
      return [...names, ...countries, ...allCountries];
    },
    run(q){
      q=q.toLowerCase();
      const pool = this.index();
      return pool.filter(x=>x.key && x.key.toLowerCase().includes(q)).slice(0,50);
    }
  };

  const searchInput = $('#globalSearch');
  const suggest = $('#suggest');
  searchInput.addEventListener('input', ()=>{
    const q=searchInput.value.trim();
    if(!q){ suggest.classList.remove('visible'); suggest.innerHTML=''; return; }
    const results = Search.run(q);
    const person = results.filter(r=>r.type==='person');
    const country = results.filter(r=>r.type==='country');
    const html = [
      person.length?'<div class="cat">People</div>'+person.map(r=>`<div data-kind="person" data-slug="${r.slug}">👤 ${r.key}</div>`).join(''):'' ,
      country.length?'<div class="cat">Countries</div>'+country.map(r=>`<div data-kind="country" data-name="${r.key}">🌍 ${r.key}</div>`).join(''):''
    ].join('');
    suggest.innerHTML = html || '<div class="empty">No matches</div>';
    suggest.classList.add('visible');
  });
  suggest.addEventListener('click', e=>{
    const row = e.target.closest('div[data-kind]'); if(!row) return;
    suggest.classList.remove('visible');
    if(row.dataset.kind==='person') Router.go('#/p/'+row.dataset.slug);
    if(row.dataset.kind==='country') Router.go('#/browse?country='+encodeURIComponent(row.dataset.name));
  });
  document.addEventListener('click', (e)=>{
    if(!suggest.contains(e.target) && e.target!==searchInput) suggest.classList.remove('visible');
  });

  // ===== VIEWS ==============================================================
  const Views = {
    appEl: $('#app'),
    render(html){ this.appEl.innerHTML = html; },

    home(){
      const latest = [...state.people].sort((a,b)=> (b.updatedAt||b.createdAt) - (a.updatedAt||a.createdAt)).slice(0,12);
      const total = state.people.length;
      this.render(`
        <div class="hero">
          <div class="card">
            <h2>Welcome</h2>
            <p>Build an infinite, local wiki of fictional supercentenarians. Everything saves to your browser (no server needed). Create pages, edit biographies, search by name or any of <span class="kbd">${COUNTRIES.length}</span> countries/territories, and export/import as JSON.</p>
            <div class="section">
              <div class="tabs">
                <span class="chip">Total profiles: <b>${fmt(total)}</b></span>
                <span class="chip">Last backup: <b>${safe(state.lastBackup||'—')}</b></span>
              </div>
              <button class="btn primary" onclick="Router.go('#/new')">+ Add Supercentenarian</button>
              <button class="btn" onclick="Router.go('#/browse')">Browse All</button>
              <button class="btn" onclick="Router.go('#/countries')">Browse by Country</button>
            </div>
            <div class="footer small">Tip: Press <span class="kbd">Ctrl/Cmd + K</span> to focus Search. Use <span class="kbd">Export</span> regularly to back up.</div>
          </div>
          <div class="card">
            <h3>Quick Stats</h3>
            <div class="list">
              <div class="list-row"><div class="spacer">Profiles</div><div><b>${fmt(total)}</b></div></div>
              <div class="list-row"><div class="spacer">Countries represented</div><div><b>${fmt(new Set(state.people.map(p=>p.birthCountry)).size)}</b></div></div>
              <div class="list-row"><div class="spacer">With awards</div><div><b>${fmt(state.people.filter(p=>safe(p.awards).trim()).length)}</b></div></div>
            </div>
          </div>
        </div>
        <div class="section">
          <h2>Latest</h2>
          ${latest.length?`<div class="grid">${latest.map(Cards.personCard).join('')}</div>`:`<div class="empty">No profiles yet. Be the first! Click <b>Add</b> above.</div>`}
        </div>
      `);
    },

    browse(){
      const url = new URL(location.href);
      const countryFilter = url.hash.includes('?country=') ? decodeURIComponent(url.hash.split('?country=')[1]) : '';
      const q = url.hash.includes('?q=') ? decodeURIComponent(url.hash.split('?q=')[1]) : '';
      let list = [...state.people];
      if(countryFilter) list = list.filter(p=>p.birthCountry===countryFilter || p.deathCountry===countryFilter);
      if(q) list = list.filter(p=> p.name.toLowerCase().includes(q.toLowerCase()));
      list.sort((a,b)=> (b.updatedAt||b.createdAt) - (a.updatedAt||a.createdAt));

      const perPage = 18;
      const page = parseInt(url.searchParams?.get('page')||'1',10) || 1; // fallback for future
      const totalPages = Math.max(1, Math.ceil(list.length/perPage));
      const subset = list.slice((page-1)*perPage, page*perPage);

      this.render(`
        <div class="section">
          <h2>Browse ${countryFilter?`— <span class='pill'>${countryFilter}</span>`:''}</h2>
          <div class="form" style="margin-bottom:10px">
            <div class="field"><input id="browseName" placeholder="Filter by name…" value="${q}" /></div>
            <div class="field"><select id="browseCountry"><option value="">All countries…</option>${COUNTRIES.map(c=>`<option ${c===countryFilter?'selected':''}>${c}</option>`).join('')}</select></div>
            <div class="field"><button class="btn" id="browseApply">Apply</button></div>
          </div>
          ${subset.length?`<div class="grid">${subset.map(Cards.personCard).join('')}</div>`:`<div class="empty">No results.</div>`}
          <div class="section small">Page ${page} of ${totalPages}</div>
        </div>
      `);
      $('#browseApply').onclick = ()=>{
        const name = $('#browseName').value.trim();
        const c = $('#browseCountry').value;
        let h = '#/browse';
        const qs=[]; if(c) qs.push('country='+encodeURIComponent(c)); if(name) qs.push('q='+encodeURIComponent(name));
        if(qs.length) h += '?'+qs.join('&');
        Router.go(h);
      };
    },

    countries(){
      const counts = {};
      for(const p of state.people){ counts[p.birthCountry] = (counts[p.birthCountry]||0)+1; }
      const rows = COUNTRIES.map(c=>({c, n: counts[c]||0})).sort((a,b)=> b.n-a.n || a.c.localeCompare(b.c));
      this.render(`
        <div class="section">
          <h2>Countries & Territories <span class="small">(${COUNTRIES.length})</span></h2>
          <div class="grid">
            ${rows.map(r=>`<div class="card" style="display:flex;justify-content:space-between;align-items:center"><div>${r.c}</div><div class="pill">${r.n}</div><button class="btn" onclick="Router.go('#/browse?country=${encodeURIComponent(r.c)}')">View</button></div>`).join('')}
          </div>
        </div>
      `);
    },

    person(slug){
      const p = state.people.find(x=>x.slug===slug);
      if(!p){ this.render(`<div class='section'><div class='empty'>Profile not found.</div></div>`); return; }
      const age = (p.birth && p.death)? yearsBetween(parseDate(p.birth), parseDate(p.death)) : (p.birth? yearsBetween(parseDate(p.birth), new Date()) : '—');
      this.render(`
        <div class="section">
          <div class="card">
            <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
              <div style="flex:1"><h2>${p.name}</h2>
                <div class="meta">${p.birthCountry||'—'} • born <b>${safe(p.birth)||'—'}</b> — died in ${p.deathCountry||'—'} <b>${safe(p.death)||'—'}</b> • Age ${age||'—'}</div>
                <div class="meta">Parents: ${safe(p.parents||'—')}</div>
                <div class="meta">Last updated: ${new Date(p.updatedAt||p.createdAt).toLocaleString()}</div>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn" onclick="Router.go('#/edit/${p.slug}')">Edit</button>
                <button class="btn warn" onclick="Actions.duplicate('${p.slug}')">Duplicate</button>
                <button class="btn" onclick="Actions.delete('${p.slug}')">Delete</button>
              </div>
            </div>
          </div>

          <div class="grid" style="margin-top:12px">
            <div class="card">
              <h3>Biography</h3>
              <div id="bio" contenteditable="true" class="list" style="padding:12px;min-height:120px">${safe(p.bio)||'<em class=small>Click to edit…</em>'}</div>
              <div style="margin-top:10px;display:flex;gap:8px"><button class="btn primary" onclick="Actions.saveBio('${p.slug}')">Save Bio</button><span class="small">Rich text allowed. Use paragraphs, lists, etc.</span></div>
            </div>
            <div class="card">
              <h3>Family</h3>
              <div class="small">Spouse(s)</div>
              ${(p.spouses||[]).length? p.spouses.map(s=>`<div class='list-row'>💍 <b>${s.name}</b> (${safe(s.birth)||'?' } – ${safe(s.death)||'?'})</div>`).join(''): '<div class="empty">None</div>'}
              <div class="small" style="margin-top:8px">Children</div>
              ${(p.children||[]).length? p.children.map(c=>`<div class='list-row'>👶 <b>${c.name}</b> (${safe(c.birth)||'?' } – ${safe(c.death)||'?'})</div>`).join(''): '<div class="empty">None</div>'}
            </div>
            <div class="card">
              <h3>Awards & Achievements</h3>
              <div class="list" id="awards" contenteditable="true" style="padding:12px;min-height:90px">${safe(p.awards)||'<em class=small>Click to add awards…</em>'}</div>
              <div style="margin-top:10px"><button class="btn" onclick="Actions.saveAwards('${p.slug}')">Save Awards</button></div>
            </div>
          </div>
        </div>
      `);
    },

    edit(slug){
      const editing = slug!=='new';
      const p = editing ? state.people.find(x=>x.slug===slug) : {name:'', birth:'', death:'', birthCountry:'', deathCountry:'', parents:'', spouses:[], children:[], awards:'', bio:''};
      if(editing && !p){ this.render(`<div class='section'><div class='empty'>Profile not found.</div></div>`); return; }
      this.render(`
        <div class="section">
          <h2>${editing?'Edit':'Create'} Supercentenarian</h2>
          <div class="form">
            <div class="field full"><label>Name</label><input id="f_name" value="${safe(p.name)}" placeholder="Full name" /></div>
            <div class="field"><label>Date of Birth (YYYY-MM-DD)</label><input id="f_birth" value="${safe(p.birth)}" placeholder="1873-05-01" /></div>
            <div class="field"><label>Date of Death (YYYY-MM-DD)</label><input id="f_death" value="${safe(p.death)}" placeholder="1989-02-14" /></div>
            <div class="field"><label>Born in (Country)</label><select id="f_birthC"><option value="">Select country…</option>${COUNTRIES.map(c=>`<option ${c===p.birthCountry?'selected':''}>${c}</option>`).join('')}</select></div>
            <div class="field"><label>Died in (Country)</label><select id="f_deathC"><option value="">Select country…</option>${COUNTRIES.map(c=>`<option ${c===p.deathCountry?'selected':''}>${c}</option>`).join('')}</select></div>
            <div class="field full"><label>Parents (names and birth/death)</label><input id="f_parents" value="${safe(p.parents)}" placeholder="e.g., Maria (1870–1950) & Jose (1868–1942)" /></div>
            <div class="field full"><label>Biography</label><textarea id="f_bio" rows="6" placeholder="Short life story…">${safe(p.bio)}</textarea></div>

            <div class="field full">
              <label>Spouse(s)</label>
              <div id="spouses" class="list"></div>
              <button class="btn" onclick="Forms.addRow('spouses')">+ Add spouse</button>
            </div>

            <div class="field full">
              <label>Children</label>
              <div id="children" class="list"></div>
              <button class="btn" onclick="Forms.addRow('children')">+ Add child</button>
            </div>

            <div class="field full"><label>Awards & Achievements (rich text allowed later on profile)</label><textarea id="f_awards" rows="4">${safe(p.awards)}</textarea></div>

            <div class="field full" style="display:flex;gap:8px;align-items:center">
              <button class="btn primary" id="saveBtn">${editing?'Save Changes':'Create Profile'}</button>
              ${editing?`<button class="btn" onclick="Router.go('#/p/${p.slug}')">Cancel</button>`:''}
            </div>
          </div>
        </div>
      `);

      // populate dynamic lists
      Forms.mount('spouses', p.spouses||[]);
      Forms.mount('children', p.children||[]);

      $('#saveBtn').onclick = ()=>{
        const next = {
          name: $('#f_name').value.trim(),
          slug: editing? p.slug : slugify($('#f_name').value.trim()||('person-'+(state.lastId+1))),
          birth: $('#f_birth').value.trim(),
          death: $('#f_death').value.trim(),
          birthCountry: $('#f_birthC').value,
          deathCountry: $('#f_deathC').value,
          parents: $('#f_parents').value.trim(),
          bio: $('#f_bio').value.trim(),
          spouses: Forms.collect('spouses'),
          children: Forms.collect('children'),
          awards: $('#f_awards').value.trim(),
        };
        if(!next.name){ toast('Name is required', 'danger'); return; }
        if(editing){ Object.assign(p, next); p.updatedAt = Date.now(); }
        else{ next.createdAt = Date.now(); next.updatedAt = Date.now(); state.lastId++; state.people.push(next); }
        DB.save(state); Router.go('#/p/'+(editing?p.slug:next.slug));
      };
    },
  };

  // ===== FORMS (dynamic spouse/child rows) ==================================
  const Forms = {
    mount(id, rows){
      const el = document.getElementById(id);
      el.innerHTML = rows.length? rows.map((r,i)=>this.rowHTML(id,i,r)).join('') : '<div class="empty">No entries yet.</div>';
    },
    rowHTML(kind, i, r){
      return `<div class="list-row" data-i="${i}">
        <input placeholder="Name" value="${safe(r.name)}" style="flex:2" />
        <input placeholder="Birth (YYYY-MM-DD)" value="${safe(r.birth)}" style="flex:1" />
        <input placeholder="Death (YYYY-MM-DD)" value="${safe(r.death)}" style="flex:1" />
        <button class="btn" onclick="Forms.remove('${kind}', ${i})">Remove</button>
      </div>`;
    },
    addRow(id){
      const el = document.getElementById(id);
      if(el.querySelector('.empty')) el.innerHTML='';
      const i = el.children.length;
      el.insertAdjacentHTML('beforeend', this.rowHTML(id, i, {name:'',birth:'',death:''}));
    },
    remove(id, index){
      const el = document.getElementById(id);
      const row = [...el.children][index]; if(row) row.remove();
      if(!el.children.length) el.innerHTML='<div class="empty">No entries yet.</div>';
    },
    collect(id){
      const el = document.getElementById(id);
      return [...el.querySelectorAll('.list-row')].map(r=>{
        const [name,birth,death] = [...r.querySelectorAll('input')].map(i=>i.value.trim());
        return {name,birth,death};
      }).filter(x=>x.name);
    }
  };

  // ===== CARDS ==============================================================
  const Cards = {
    personCard(p){
      const age = (p.birth && p.death)? yearsBetween(parseDate(p.birth), parseDate(p.death)) : '—';
      return `<div class="card">
        <h3>${p.name}</h3>
        <div class="meta">${p.birthCountry||'—'} → ${p.deathCountry||'—'}</div>
        <div class="meta">${safe(p.birth)||'—'} – ${safe(p.death)||'—'} • Age ${age}</div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <span class="pill">Spouses: ${(p.spouses||[]).length}</span>
          <span class="pill">Children: ${(p.children||[]).length}</span>
        </div>
        <div style="margin-top:10px"><button class="btn" onclick="Router.go('#/p/${p.slug}')">Open Page</button></div>
      </div>`;
    }
  };

  // ===== INLINE ACTIONS =====================================================
  const Actions = {
    saveBio(slug){
      const p = state.people.find(x=>x.slug===slug); if(!p) return;
      p.bio = $('#bio').innerHTML; p.updatedAt = Date.now(); DB.save(state); toast('Biography saved','ok');
    },
    saveAwards(slug){
      const p = state.people.find(x=>x.slug===slug); if(!p) return;
      $('#awards').querySelectorAll('script').forEach(s=>s.remove()); // safety
      p.awards = $('#awards').innerHTML; p.updatedAt = Date.now(); DB.save(state); toast('Awards saved','ok');
    },
    duplicate(slug){
      const p = state.people.find(x=>x.slug===slug); if(!p) return;
      const copy = JSON.parse(JSON.stringify(p));
      copy.name = p.name + ' (Copy)'; copy.slug = slugify(copy.name + '-' + (state.lastId+1)); copy.createdAt = Date.now(); copy.updatedAt = Date.now();
      state.lastId++; state.people.push(copy); DB.save(state); Router.go('#/edit/'+copy.slug);
    },
    delete(slug){
      if(!confirm('Delete this profile? This cannot be undone.')) return;
      state.people = state.people.filter(x=>x.slug!==slug); DB.save(state); toast('Deleted','danger'); Router.go('#/browse');
    }
  };

  // ===== SHORTCUTS ==========================================================
  document.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){
      e.preventDefault(); searchInput.focus(); searchInput.select();
    }
  });

  // ===== SAMPLE DATA (optional bootstrap if empty) ==========================
  if(!state.people.length){
    const sample = {
      name:'Luciana Rivera de Ávila',
      slug:'luciana-rivera-de-avila',
      birth:'1889-03-14', death:'2003-07-09',
      birthCountry:'Venezuela', deathCountry:'Spain',
      parents:'Carmen Rivera (1860–1930) & Julio Ávila (1857–1932)',
      spouses:[{name:'Esteban Flores',birth:'1886-06-01',death:'1958-11-12'}],
      children:[{name:'Isabel Flores',birth:'1910-01-05',death:'1992-04-20'},{name:'Rafael Flores',birth:'1913-09-12',death:'2001-01-30'}],
      awards:'<ul><li>Order of Cultural Merit (1962)</li><li>City of Valencia Centennial Medal (1989)</li></ul>',
      bio:'<p>Luciana was a weaver, educator, and community archivist whose notebooks preserved the oral histories of three towns through the 20th century. She migrated to Valencia, Spain in 1956.</p>',
      createdAt: Date.now(), updatedAt: Date.now()
    };
    state.people.push(sample); state.lastId=1; DB.save(state);
  }

  </script>
</body>
</html>
